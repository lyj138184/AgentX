# AgentX All-in-One Docker Image
# åŒ…å«æ•´ä¸ª AgentX ç³»ç»Ÿçš„å•ä¸€é•œåƒéƒ¨ç½²æ–¹æ¡ˆ

FROM docker:27-dind

# å®‰è£…å¿…è¦çš„å·¥å…·
RUN apk add --no-cache \
    curl \
    bash \
    git \
    docker-compose \
    postgresql-client \
    netcat-openbsd \
    jq

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /agentx

# å¤åˆ¶éƒ¨ç½²é…ç½®æ–‡ä»¶
COPY docker-compose.standalone.yml /agentx/docker-compose.yml
COPY deploy.sh /agentx/deploy.sh
COPY DEPLOYMENT.md /agentx/README.md
COPY .env.example /agentx/.env.example

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /agentx/start-agentx.sh << 'EOF'
#!/bin/bash

set -e

echo "ğŸš€ Starting AgentX All-in-One Container..."

# æ£€æŸ¥å¹¶å¤„ç† .env æ–‡ä»¶
if [ -f "/agentx/config/.env" ]; then
    echo "ğŸ“ Found custom .env file, using it..."
    cp /agentx/config/.env /agentx/.env
elif [ ! -f "/agentx/.env" ]; then
    echo "ğŸ“ No .env file found, creating default one..."
    cp /agentx/.env.example /agentx/.env
    echo "âš ï¸  Using default configuration. Please mount your .env file to /agentx/config/.env for custom settings."
fi

# å¯åŠ¨ Docker daemon
echo "Starting Docker daemon..."
dockerd-entrypoint.sh &
DOCKER_PID=$!

# ç­‰å¾… Docker daemon å¯åŠ¨
echo "Waiting for Docker daemon to start..."
for i in {1..30}; do
    if docker info >/dev/null 2>&1; then
        echo "Docker daemon is ready!"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "Docker daemon failed to start"
        exit 1
    fi
    sleep 2
done

# é¢„æ‹‰å–é•œåƒä»¥åŠ å¿«å¯åŠ¨é€Ÿåº¦
echo "Pre-pulling required images..."
docker pull ankane/pgvector:latest
docker pull postgres:15-alpine
docker pull ghcr.io/lucky-aeon/mcp-gateway:latest
docker pull ghcr.io/xhy/agentx-2/frontend:latest
docker pull ghcr.io/xhy/agentx-2/backend:latest
docker pull ghcr.io/xhy/agentx-2/api-gateway:latest

# å¯åŠ¨ AgentX æœåŠ¡
echo "Starting AgentX services..."
docker compose --env-file /agentx/.env up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "Waiting for services to be ready..."
for i in {1..60}; do
    if curl -s http://localhost:3000 >/dev/null 2>&1; then
        echo "âœ… AgentX services are ready!"
        break
    fi
    if [ $i -eq 60 ]; then
        echo "âš ï¸  Services startup timeout, but continuing..."
        break
    fi
    sleep 5
done

echo ""
echo "ğŸ‰ AgentX is now running!"
echo ""
echo "Access URLs:"
echo "  ğŸ“± Frontend:  http://localhost:3000"
echo "  ğŸ”Œ Backend:   http://localhost:8080"
echo "  ğŸšª Gateway:   http://localhost:8081"
echo ""
echo "Default credentials:"
echo "  ğŸ‘¤ Admin:     admin@agentx.ai / admin123"
echo "  ğŸ‘¤ Test User: test@agentx.ai / test123"
echo ""

# æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
docker compose --env-file /agentx/.env ps

# ä¿æŒå®¹å™¨è¿è¡Œå¹¶è·Ÿè¸ªæ—¥å¿—
wait $DOCKER_PID
EOF

# åˆ›å»ºåœæ­¢è„šæœ¬
RUN cat > /agentx/stop-agentx.sh << 'EOF'
#!/bin/bash

echo "ğŸ›‘ Stopping AgentX services..."
docker compose --env-file /agentx/.env down

echo "âœ… AgentX services stopped"
EOF

# è®¾ç½®æ‰§è¡Œæƒé™
RUN chmod +x /agentx/start-agentx.sh /agentx/stop-agentx.sh /agentx/deploy.sh

# æš´éœ²ç«¯å£
EXPOSE 3000 8080 8081 5432 5433 8005

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DOCKER_TLS_CERTDIR=""
ENV DOCKER_HOST=unix:///var/run/docker.sock

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000 || exit 1

# è®¾ç½®å¯åŠ¨å‘½ä»¤
CMD ["/agentx/start-agentx.sh"]