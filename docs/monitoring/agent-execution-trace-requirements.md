# Agentæ‰§è¡Œé“¾è·¯è¿½è¸ªéœ€æ±‚æ–‡æ¡£

## ğŸ“‹ ä¸šåŠ¡èƒŒæ™¯

### é¡¹ç›®æ¦‚è¿°
AgentXé‡‡ç”¨DDDæ¶æ„ï¼Œæ¯ä¸ªAgentä¼šè¯éƒ½ä¼šç»è¿‡å¤æ‚çš„æ‰§è¡Œé“¾è·¯ï¼šé«˜å¯ç”¨æ¨¡å‹è°ƒåº¦ â†’ æ¶ˆæ¯å¤„ç† â†’ å·¥å…·è°ƒç”¨ â†’ å“åº”ç”Ÿæˆã€‚ç”¨æˆ·éœ€è¦èƒ½å¤Ÿè¿½æº¯å’ŒæŸ¥çœ‹æ¯ä¸ªä¼šè¯çš„å®Œæ•´æ‰§è¡Œé“¾è·¯ï¼Œäº†è§£Agent"æ˜¯å¦‚ä½•å·¥ä½œçš„"ã€‚

### æ ¸å¿ƒéœ€æ±‚
å®ç°**Agentæ‰§è¡Œé“¾è·¯è¿½è¸ªæ—¥å¿—**ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿï¼š
1. **æ‰§è¡Œè¿‡ç¨‹å¯è§†åŒ–** - çœ‹åˆ°Agentæ‰§è¡Œçš„æ¯ä¸ªæ­¥éª¤å’ŒæŠ€æœ¯ç»†èŠ‚
2. **é—®é¢˜æ’æŸ¥æ”¯æŒ** - å½“Agentè¡¨ç°å¼‚å¸¸æ—¶ï¼Œèƒ½å¤Ÿå®šä½å…·ä½“åŸå› 
3. **æˆæœ¬æ¶ˆè€—é€æ˜** - æ¸…æ¥šäº†è§£æ¯æ¬¡å¯¹è¯çš„Tokenæ¶ˆè€—å’Œè´¹ç”¨æ˜ç»†
4. **æŠ€æœ¯ç»†èŠ‚æš´éœ²** - äº†è§£æ¨¡å‹é€‰æ‹©ã€å·¥å…·è°ƒç”¨ã€å‚æ•°ä¼ é€’ç­‰åº•å±‚æœºåˆ¶

### åº”ç”¨åœºæ™¯
- **ç”¨æˆ·ä½¿ç”¨åœºæ™¯**ï¼šæŸ¥çœ‹è‡ªå·±ä¸Agentå¯¹è¯çš„è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹
- **Agentå¼€å‘åœºæ™¯**ï¼šAgentåˆ›å»ºè€…æµ‹è¯•å’Œè°ƒè¯•è‡ªå·±åˆ›å»ºçš„Agent
- **é—®é¢˜æ’æŸ¥åœºæ™¯**ï¼šå½“Agentå“åº”å¼‚å¸¸æ—¶ï¼ŒæŸ¥çœ‹å…·ä½“çš„æ‰§è¡Œé“¾è·¯å®šä½é—®é¢˜

## ğŸ” Agentæ‰§è¡Œé“¾è·¯åˆ†æ

åŸºäºAgentXé¡¹ç›®ä»£ç åˆ†æï¼ŒAgentæ‰§è¡Œçš„å®Œæ•´é“¾è·¯å¦‚ä¸‹ï¼š

### 1. è¯·æ±‚æ¥æ”¶é˜¶æ®µ
```
ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ ConversationAppService.chat()
â””â”€â”€ å‚æ•°ï¼šChatRequest(message, agentId, sessionId, fileUrls)
â””â”€â”€ ç”¨æˆ·èº«ä»½éªŒè¯ï¼šUserContext.getCurrentUserId()
```

### 2. ç¯å¢ƒå‡†å¤‡é˜¶æ®µ  
```
prepareEnvironment()
â”œâ”€â”€ è·å–ä¼šè¯ä¿¡æ¯ï¼šsessionDomainService.getSession()
â”œâ”€â”€ è·å–Agenté…ç½®ï¼šagentDomainService.getAgentById()
â”œâ”€â”€ è·å–å·¥å…·åˆ—è¡¨ï¼šgetMcpServerNames()
â”œâ”€â”€ è·å–å·¥ä½œç©ºé—´ï¼šagentWorkspaceDomainService.getWorkspace()
â””â”€â”€ é«˜å¯ç”¨æ¨¡å‹é€‰æ‹©ï¼šhighAvailabilityDomainService.selectBestProvider()
    â”œâ”€â”€ è¾“å…¥ï¼šmodel, userId, sessionId, fallbackChain
    â”œâ”€â”€ ä¼šè¯äº²å’Œæ€§ï¼šAffinityType.SESSION
    â”œâ”€â”€ é™çº§é“¾ï¼šç”¨æˆ·é…ç½®çš„æ¨¡å‹é™çº§é¡ºåº
    â””â”€â”€ è¾“å‡ºï¼šHighAvailabilityResult(provider, model, instanceId)
```

### 3. æ¶ˆæ¯å¤„ç†é˜¶æ®µ
```
AbstractMessageHandler.chat()
â”œâ”€â”€ åˆ›å»ºè¿æ¥ï¼štransport.createConnection(CONNECTION_TIMEOUT)
â”œâ”€â”€ ä½™é¢æ£€æŸ¥ï¼šcheckBalanceBeforeChat()
â”œâ”€â”€ åˆ›å»ºæ¶ˆæ¯å®ä½“ï¼šcreateLlmMessage() + createUserMessage()
â”œâ”€â”€ åˆå§‹åŒ–èŠå¤©å†…å­˜ï¼šinitMemory() + buildHistoryMessage()
â”œâ”€â”€ è·å–å·¥å…·æä¾›è€…ï¼šprovideTools() â†’ AgentToolManager.createToolProvider()
â””â”€â”€ æ‰§è¡Œå¯¹è¯ï¼šprocessStreamingChat() æˆ– processSyncChat()
```

### 4. æ¨¡å‹è°ƒç”¨é˜¶æ®µ
```
LLMå®¢æˆ·ç«¯è°ƒç”¨
â”œâ”€â”€ è·å–å®¢æˆ·ç«¯ï¼šllmServiceFactory.getStreamingClient(provider, model)
â”œâ”€â”€ æ„å»ºAgentï¼šbuildStreamingAgent(client, toolProvider)
â”œâ”€â”€ å‘èµ·è°ƒç”¨ï¼šagent.chat(userMessage)
â””â”€â”€ TokenStreamå¤„ç†ï¼š
    â”œâ”€â”€ onPartialResponseï¼šæµå¼å“åº”å¤„ç†
    â”œâ”€â”€ onCompleteResponseï¼šå®Œæ•´å“åº”å’ŒTokenç»Ÿè®¡
    â”œâ”€â”€ onToolExecutedï¼šå·¥å…·è°ƒç”¨å¤„ç†
    â””â”€â”€ onErrorï¼šé”™è¯¯å¤„ç†å’Œé«˜å¯ç”¨ä¸ŠæŠ¥
```

### 5. å·¥å…·è°ƒç”¨é˜¶æ®µ
```
AgentToolManagerå·¥å…·è°ƒç”¨
â”œâ”€â”€ MCPå®¢æˆ·ç«¯åˆ›å»ºï¼šMcpTransport + McpClient
â”œâ”€â”€ å·¥å…·å‘ç°ï¼šclient.listTools()
â”œâ”€â”€ å·¥å…·æ‰§è¡Œï¼šclient.callTool(toolName, arguments)
â””â”€â”€ ç»“æœå¤„ç†ï¼šè¿”å›å·¥å…·æ‰§è¡Œç»“æœ
```

### 6. ç»“æœå¤„ç†é˜¶æ®µ
```
å“åº”å®Œæˆå¤„ç†
â”œâ”€â”€ ä¿å­˜æ¶ˆæ¯ï¼šmessageDomainService.saveMessage()
â”œâ”€â”€ æ›´æ–°Tokenä¿¡æ¯ï¼šè®¾ç½®inputTokens + outputTokens
â”œâ”€â”€ æ‰§è¡Œè®¡è´¹ï¼šbillingService.charge(billingContext)
â”œâ”€â”€ ä¸ŠæŠ¥é«˜å¯ç”¨ç»“æœï¼šreportCallResult(instanceId, success, latency)
â””â”€â”€ è¿”å›å“åº”ï¼štransport.sendMessage()
```

## ğŸ“Š é“¾è·¯è¿½è¸ªç›‘æ§æŒ‡æ ‡

### ç”¨æˆ·ç»´åº¦ç›‘æ§
æ‰€æœ‰è¿½è¸ªæ•°æ®ä»¥**ç”¨æˆ·ä¼šè¯**ä¸ºä¸­å¿ƒï¼Œæ¯ä¸ªä¼šè¯ç”Ÿæˆä¸€æ¡å®Œæ•´çš„æ‰§è¡Œé“¾è·¯è®°å½•ã€‚

### 1. ä¼šè¯åŸºç¡€ä¿¡æ¯
```yaml
ä¼šè¯æ ‡è¯†:
  - traceId: æ‰§è¡Œè¿½è¸ªID (å”¯ä¸€æ ‡è¯†ä¸€æ¬¡å®Œæ•´æ‰§è¡Œ)
  - sessionId: ä¼šè¯ID
  - userId: ç”¨æˆ·ID
  - agentId: Agent ID
  - agentName: Agentåç§°
  - timestamp: æ‰§è¡Œå¼€å§‹æ—¶é—´

ç”¨æˆ·è¾“å…¥:
  - userMessage: ç”¨æˆ·å‘é€çš„åŸå§‹æ¶ˆæ¯å†…å®¹
  - fileUrls: é™„ä»¶æ–‡ä»¶åˆ—è¡¨ (å¦‚æœæœ‰)
  - messageType: æ¶ˆæ¯ç±»å‹ (TEXT/IMAGE/FILE)

Agentå“åº”:
  - agentResponse: Agentçš„å®Œæ•´å“åº”å†…å®¹  
  - responseType: å“åº”ç±»å‹
  - isStreaming: æ˜¯å¦ä¸ºæµå¼å“åº”
```

### 2. é«˜å¯ç”¨æ¨¡å‹è°ƒåº¦è®°å½•
```yaml
æ¨¡å‹é€‰æ‹©è¿‡ç¨‹:
  - originalModelId: åŸå§‹è¯·æ±‚çš„æ¨¡å‹ID
  - originalProviderName: åŸå§‹æ¨¡å‹æä¾›å•†
  - selectedModelId: å®é™…ä½¿ç”¨çš„æ¨¡å‹ID
  - selectedProviderName: å®é™…ä½¿ç”¨çš„æä¾›å•†
  - instanceId: é«˜å¯ç”¨ç½‘å…³åˆ†é…çš„å®ä¾‹ID

ä¼šè¯äº²å’Œæ€§:
  - hasSessionAffinity: æ˜¯å¦å¯ç”¨ä¼šè¯äº²å’Œæ€§
  - affinityKey: äº²å’Œæ€§é”®å€¼
  - previousInstanceId: ä¹‹å‰ä½¿ç”¨çš„å®ä¾‹ID (å¦‚æœæœ‰)

æ¨¡å‹é™çº§ä¿¡æ¯:
  - isModelDegraded: æ˜¯å¦å‘ç”Ÿäº†æ¨¡å‹é™çº§
  - degradeReason: é™çº§åŸå›  (æ¨¡å‹ä¸å¥åº·/è´Ÿè½½è¿‡é«˜/æœåŠ¡å¼‚å¸¸)
  - fallbackChain: ç”¨æˆ·é…ç½®çš„é™çº§é“¾
  - fallbackLevel: é™çº§ç­‰çº§ (ä½¿ç”¨é™çº§é“¾ä¸­çš„ç¬¬å‡ ä¸ª)

é«˜å¯ç”¨ç½‘å…³çŠ¶æ€:
  - gatewayEnabled: é«˜å¯ç”¨ç½‘å…³æ˜¯å¦å¯ç”¨
  - gatewayResponse: ç½‘å…³è¿”å›çš„é€‰æ‹©ç»“æœ
  - fallbackToDefault: æ˜¯å¦é™çº§åˆ°é»˜è®¤é€»è¾‘
  - gatewayLatency: ç½‘å…³å“åº”æ—¶é—´
```

### 3. Tokenä½¿ç”¨å’Œè®¡è´¹æ˜ç»†
```yaml
Tokenç»Ÿè®¡:
  - inputTokens: è¾“å…¥Tokenæ•°é‡
  - outputTokens: è¾“å‡ºTokenæ•°é‡  
  - totalTokens: æ€»Tokenæ•°é‡

è®¡è´¹ä¿¡æ¯:
  - serviceId: è®¡è´¹æœåŠ¡ID (æ¨¡å‹è¡¨ä¸»é”®)
  - inputCost: è¾“å…¥Tokenæˆæœ¬
  - outputCost: è¾“å‡ºTokenæˆæœ¬
  - totalCost: æ€»è®¡è´¹é‡‘é¢
  - billingRequestId: è®¡è´¹è¯·æ±‚ID (å¹‚ç­‰æ€§)
  - billingSuccess: è®¡è´¹æ˜¯å¦æˆåŠŸ
  - billingErrorMessage: è®¡è´¹é”™è¯¯ä¿¡æ¯ (å¦‚æœå¤±è´¥)

æ¨¡å‹å®šä»·:
  - inputPricePerToken: è¾“å…¥Tokenå•ä»·
  - outputPricePerToken: è¾“å‡ºTokenå•ä»·
  - pricingConfig: æ¨¡å‹å®šä»·é…ç½®
```

### 4. å·¥å…·è°ƒç”¨æ‰§è¡Œè®°å½•
```yaml
å·¥å…·è°ƒç”¨åºåˆ—:
  - toolCallCount: å·¥å…·è°ƒç”¨æ€»æ•°
  - toolCalls: å·¥å…·è°ƒç”¨åˆ—è¡¨

å•ä¸ªå·¥å…·è°ƒç”¨:
  - sequence: è°ƒç”¨åºå·
  - toolName: å·¥å…·åç§°
  - mcpServerName: MCPæœåŠ¡å™¨åç§°
  - toolDescription: å·¥å…·åŠŸèƒ½æè¿°

è°ƒç”¨å‚æ•°:
  - requestArguments: å®Œæ•´çš„è°ƒç”¨å‚æ•° (JSON)
  - argumentTypes: å‚æ•°ç±»å‹ä¿¡æ¯
  - presetParams: å·¥å…·é¢„è®¾å‚æ•° (æ¥è‡ªAgenté…ç½®)

æ‰§è¡Œç»“æœ:
  - response: å·¥å…·è¿”å›çš„å®Œæ•´ç»“æœ
  - success: æ‰§è¡Œæ˜¯å¦æˆåŠŸ
  - errorMessage: é”™è¯¯ä¿¡æ¯ (å¦‚æœå¤±è´¥)
  - executionTime: å·¥å…·æ‰§è¡Œè€—æ—¶ (æ¯«ç§’)

MCPè¿æ¥ä¿¡æ¯:
  - mcpTransportUrl: MCPä¼ è¾“å±‚URL
  - connectionSuccess: MCPè¿æ¥æ˜¯å¦æˆåŠŸ
  - mcpClientId: MCPå®¢æˆ·ç«¯æ ‡è¯†
```

### 5. æ‰§è¡Œé˜¶æ®µæ—¶é—´è®°å½•
```yaml
æ‰§è¡Œé˜¶æ®µè€—æ—¶:
  - totalExecutionTime: æ€»æ‰§è¡Œæ—¶é—´ (æ¯«ç§’)
  - environmentPrepareTime: ç¯å¢ƒå‡†å¤‡è€—æ—¶
  - balanceCheckTime: ä½™é¢æ£€æŸ¥è€—æ—¶
  - memoryInitTime: èŠå¤©å†…å­˜åˆå§‹åŒ–è€—æ—¶
  - modelCallTime: æ¨¡å‹è°ƒç”¨è€—æ—¶
  - toolExecutionTime: å·¥å…·æ‰§è¡Œæ€»è€—æ—¶
  - billingTime: è®¡è´¹å¤„ç†è€—æ—¶

æµå¼å“åº”æ—¶é—´:
  - firstTokenTime: é¦–Tokenå“åº”æ—¶é—´ (TTFB)
  - streamingDuration: æµå¼å“åº”æ€»æ—¶é•¿
  - avgTokensPerSecond: å¹³å‡Tokenç”Ÿæˆé€Ÿåº¦
```

### 6. é”™è¯¯å’Œå¼‚å¸¸è®°å½•
```yaml
æ‰§è¡ŒçŠ¶æ€:
  - success: æ•´ä½“æ‰§è¡Œæ˜¯å¦æˆåŠŸ
  - errorPhase: é”™è¯¯å‘ç”Ÿçš„é˜¶æ®µ
  - errorType: é”™è¯¯ç±»å‹ (BUSINESS/TECHNICAL/MODEL)

é”™è¯¯è¯¦æƒ…:
  - errorMessage: è¯¦ç»†é”™è¯¯ä¿¡æ¯
  - errorCode: é”™è¯¯ç 
  - stackTrace: å¼‚å¸¸å †æ ˆ (å¼€å‘æ¨¡å¼)

æ¢å¤å¤„ç†:
  - autoRetry: æ˜¯å¦è‡ªåŠ¨é‡è¯•
  - retryCount: é‡è¯•æ¬¡æ•°
  - retrySuccess: é‡è¯•æ˜¯å¦æˆåŠŸ
  - fallbackAction: é™çº§å¤„ç†åŠ¨ä½œ
```

### 7. ç³»ç»Ÿä¸Šä¸‹æ–‡ä¿¡æ¯
```yaml
æ‰§è¡Œç¯å¢ƒ:
  - serverInstanceId: æœåŠ¡å™¨å®ä¾‹ID
  - executionThreadId: æ‰§è¡Œçº¿ç¨‹ID
  - memoryUsage: å†…å­˜ä½¿ç”¨æƒ…å†µ
  - connectionPoolStatus: è¿æ¥æ± çŠ¶æ€

ç”¨æˆ·é…ç½®:
  - userFallbackChain: ç”¨æˆ·é…ç½®çš„æ¨¡å‹é™çº§é“¾
  - userToolPresets: ç”¨æˆ·çš„å·¥å…·é¢„è®¾å‚æ•°
  - userWorkspaceId: ç”¨æˆ·å·¥ä½œç©ºé—´ID

Agenté…ç½®:
  - agentSystemPrompt: Agentç³»ç»Ÿæç¤ºè¯æ‘˜è¦
  - agentToolConfigs: Agentå·¥å…·é…ç½®
  - agentModelConfigs: Agentæ¨¡å‹é…ç½®
```

## ğŸ¯ é“¾è·¯è¿½è¸ªåœºæ™¯ç¤ºä¾‹

### åœºæ™¯1ï¼šæ­£å¸¸æ‰§è¡Œé“¾è·¯
```
æ‰§è¡Œè¿½è¸ª [trace_1738305025_a8b9c1d2]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ä¼šè¯ä¿¡æ¯
   ä¼šè¯ID: session_20250131_143025
   Agent: ç¼–ç¨‹åŠ©æ‰‹ (agent_coding_assistant)
   ç”¨æˆ·æ¶ˆæ¯: "å¸®æˆ‘å†™ä¸€ä¸ªPythonå¿«é€Ÿæ’åºå‡½æ•°"
   æ‰§è¡Œæ—¶é—´: 2025-01-31 14:30:25

ğŸ¯ æ¨¡å‹è°ƒåº¦
   è¯·æ±‚æ¨¡å‹: GPT-4 Turbo (gpt-4-turbo-2024-04-09)
   å®é™…ä½¿ç”¨: GPT-4 Turbo (gpt-4-turbo-2024-04-09)
   æä¾›å•†: OpenAI
   å®ä¾‹ID: instance-us-east-1-003
   é«˜å¯ç”¨çŠ¶æ€: âœ… æ­£å¸¸è°ƒåº¦
   ä¼šè¯äº²å’Œæ€§: âœ… å·²ç»‘å®šåˆ°åŒä¸€å®ä¾‹

ğŸ’¬ æ¶ˆæ¯å¤„ç†
   ç¯å¢ƒå‡†å¤‡: 45ms
   ä½™é¢æ£€æŸ¥: 12ms âœ… ä½™é¢å……è¶³
   èŠå¤©å†…å­˜: 23ms (åŠ è½½å†å²3æ¡æ¶ˆæ¯)
   å·¥å…·å‡†å¤‡: 67ms (åŠ è½½2ä¸ªå·¥å…·: code_runner, file_manager)

ğŸ¤– æ¨¡å‹è°ƒç”¨
   è°ƒç”¨å¼€å§‹: 14:30:25.123
   é¦–Tokenæ—¶é—´: 1,247ms
   æµå¼å“åº”: 3,456ms
   è¾“å…¥Token: 145
   è¾“å‡ºToken: 312
   æ€»Token: 457
   æˆæœ¬: Â¥0.0184

ğŸ› ï¸ å·¥å…·è°ƒç”¨ (1æ¬¡)
   å·¥å…·: code_runner
   è°ƒç”¨æ—¶é—´: 14:30:28.789
   å‚æ•°: {"code": "def quicksort(arr):\n...", "language": "python"}
   ç»“æœ: âœ… ä»£ç æ‰§è¡ŒæˆåŠŸï¼Œè¾“å‡ºæµ‹è¯•ç»“æœ
   è€—æ—¶: 892ms

ğŸ’° è®¡è´¹å¤„ç†
   è®¡è´¹è¯·æ±‚ID: billing_1738305025_001
   æœåŠ¡ID: model_gpt4_turbo
   è®¡è´¹é‡‘é¢: Â¥0.0184
   è®¡è´¹çŠ¶æ€: âœ… æˆåŠŸ

ğŸ“Š æ‰§è¡Œæ€»ç»“
   æ€»æ‰§è¡Œæ—¶é—´: 4,567ms
   æ‰§è¡ŒçŠ¶æ€: âœ… æˆåŠŸå®Œæˆ
   é«˜å¯ç”¨ä¸ŠæŠ¥: âœ… æˆåŠŸä¸ŠæŠ¥ (success=true, latency=4567ms)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### åœºæ™¯2ï¼šæ¨¡å‹é™çº§é“¾è·¯
```
æ‰§è¡Œè¿½è¸ª [trace_1738305125_b9c2d3e4]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ä¼šè¯ä¿¡æ¯
   ä¼šè¯ID: session_20250131_143125
   Agent: ç¿»è¯‘åŠ©æ‰‹ (agent_translator)
   ç”¨æˆ·æ¶ˆæ¯: "è¯·ç¿»è¯‘è¿™æ®µè‹±æ–‡..."

âš ï¸ æ¨¡å‹è°ƒåº¦å¼‚å¸¸
   è¯·æ±‚æ¨¡å‹: Claude-3.5-Sonnet
   å®é™…ä½¿ç”¨: GPT-4 Turbo (é™çº§)
   é™çº§åŸå› : Claudeæ¨¡å‹å®ä¾‹ä¸å¥åº·
   é™çº§é“¾: [claude-3-5-sonnet, gpt-4-turbo, gpt-3.5-turbo]
   é™çº§ç­‰çº§: ç¬¬2çº§
   å®ä¾‹ID: instance-us-east-1-005

ğŸ”„ é«˜å¯ç”¨å¤„ç†è¿‡ç¨‹
   1. å°è¯•Claude-3.5-Sonnet â†’ âŒ å®ä¾‹å¥åº·æ£€æŸ¥å¤±è´¥
   2. é™çº§åˆ°GPT-4 Turbo â†’ âœ… å®ä¾‹å¥åº·æ­£å¸¸
   3. ä¼šè¯äº²å’Œæ€§æ›´æ–°: ç»‘å®šåˆ°æ–°å®ä¾‹

ğŸ’¬ æ¶ˆæ¯å¤„ç†
   [æ­£å¸¸å¤„ç†æµç¨‹...]

ğŸ¤– æ¨¡å‹è°ƒç”¨
   é™çº§è¯´æ˜: ç”±äºClaudeæ¨¡å‹æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°GPT-4 Turbo
   æ¨¡å‹å‚æ•°è°ƒæ•´: temperature=0.3 (é€‚é…ç¿»è¯‘ä»»åŠ¡)
   [è°ƒç”¨è¯¦æƒ…...]

ğŸ“Š æ‰§è¡Œæ€»ç»“
   æ‰§è¡ŒçŠ¶æ€: âœ… æˆåŠŸå®Œæˆ (å·²é™çº§)
   é«˜å¯ç”¨ä¸ŠæŠ¥: âœ… ä¸ŠæŠ¥é™çº§ç»“æœå’Œæ–°å®ä¾‹æ€§èƒ½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### åœºæ™¯3ï¼šå·¥å…·è°ƒç”¨å¤±è´¥é“¾è·¯
```
æ‰§è¡Œè¿½è¸ª [trace_1738305225_c0d3e4f5]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ä¼šè¯ä¿¡æ¯
   ç”¨æˆ·æ¶ˆæ¯: "å¸®æˆ‘æœç´¢æœ€æ–°çš„AIæ–°é—»"

ğŸ› ï¸ å·¥å…·è°ƒç”¨å¼‚å¸¸
   å·¥å…·: web_search
   MCPæœåŠ¡å™¨: mcp_web_tools
   è°ƒç”¨å‚æ•°: {"query": "AI news 2025", "limit": 10}
   é”™è¯¯ä¿¡æ¯: MCPè¿æ¥è¶…æ—¶ (connection timeout after 30s)
   
ğŸ”„ é”™è¯¯å¤„ç†æµç¨‹
   1. æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨å¤±è´¥
   2. å°è¯•é‡è¿MCPæœåŠ¡å™¨ â†’ âŒ ä»ç„¶å¤±è´¥
   3. Agenté™çº§åˆ°æ— å·¥å…·æ¨¡å¼
   4. åŸºäºå·²æœ‰çŸ¥è¯†å›ç­”

ğŸ’¬ Agentå“åº”ç­–ç•¥
   åŸè®¡åˆ’: ä½¿ç”¨web_searchè·å–æœ€æ–°æ–°é—» â†’ å·¥å…·è°ƒç”¨å¤±è´¥
   é™çº§æ–¹æ¡ˆ: åŸºäºè®­ç»ƒæ•°æ®æä¾›AIé¢†åŸŸæ¦‚è¿°
   ç”¨æˆ·é€šçŸ¥: "æŠ±æ­‰ï¼Œç½‘ç»œæœç´¢åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œæˆ‘åŸºäºå·²æœ‰çŸ¥è¯†ä¸ºæ‚¨ä»‹ç»..."

ğŸ“Š æ‰§è¡Œæ€»ç»“
   æ‰§è¡ŒçŠ¶æ€: âš ï¸ éƒ¨åˆ†æˆåŠŸ (å·¥å…·åŠŸèƒ½å—é™)
   ç”¨æˆ·ä½“éªŒ: ä»ç„¶è·å¾—äº†æœ‰ç”¨çš„å›ç­”
   é—®é¢˜ä¸ŠæŠ¥: âœ… å·²ä¸ŠæŠ¥MCPæœåŠ¡å¼‚å¸¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### æ•°æ®æ”¶é›†æ–¹æ¡ˆ
- **åŸ‹ç‚¹ä½ç½®**: åœ¨AbstractMessageHandlerçš„å…³é”®èŠ‚ç‚¹åŸ‹ç‚¹
- **æ•°æ®å­˜å‚¨**: å¼‚æ­¥å­˜å‚¨ï¼Œä¸å½±å“å¯¹è¯å“åº”æ€§èƒ½  
- **é“¾è·¯æ ‡è¯†**: ä½¿ç”¨traceIdå…³è”æ•´ä¸ªæ‰§è¡Œé“¾è·¯çš„æ‰€æœ‰èŠ‚ç‚¹

### æ•°æ®å­˜å‚¨è®¾è®¡
- **ä¸»è¡¨**: agent_execution_traces (æ‰§è¡Œé“¾è·¯ä¸»è®°å½•)
- **è¯¦æƒ…è¡¨**: model_call_details, tool_call_details, error_details
- **ç´¢å¼•**: ç”¨æˆ·ID + æ—¶é—´ã€ä¼šè¯IDã€Agent ID

### ç”¨æˆ·ç•Œé¢è®¾è®¡
- **é“¾è·¯è¯¦æƒ…é¡µ**: æ˜¾ç¤ºå•æ¬¡æ‰§è¡Œçš„å®Œæ•´é“¾è·¯ä¿¡æ¯
- **ä¼šè¯å†å²é¡µ**: åˆ—å‡ºç”¨æˆ·çš„æ‰€æœ‰æ‰§è¡Œé“¾è·¯è®°å½•
- **æœç´¢è¿‡æ»¤**: æŒ‰Agentã€æ—¶é—´ã€çŠ¶æ€ç­‰æ¡ä»¶ç­›é€‰
- **å¯¼å‡ºåŠŸèƒ½**: å¯¼å‡ºé“¾è·¯æ•°æ®ç”¨äºåˆ†ææˆ–é—®é¢˜æ’æŸ¥

## ğŸ’¡ æ ¸å¿ƒä»·å€¼

1. **æŠ€æœ¯é€æ˜åŒ–**: ç”¨æˆ·æ¸…æ¥šäº†è§£Agentçš„å·¥ä½œæœºåˆ¶
2. **é—®é¢˜æ’æŸ¥**: å¿«é€Ÿå®šä½Agentå¼‚å¸¸çš„æ ¹æœ¬åŸå› 
3. **æˆæœ¬å¯æ§**: ç²¾ç¡®çš„Tokenå’Œè´¹ç”¨æ˜ç»†
4. **å¼€å‘æ”¯æŒ**: Agentåˆ›å»ºè€…å¯ä¼˜åŒ–Agenté…ç½®å’Œå·¥å…·é€‰æ‹©
5. **ç”¨æˆ·æ•™è‚²**: å¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨AI Agent